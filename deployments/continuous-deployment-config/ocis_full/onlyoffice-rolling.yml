---
- name: continuous-deployment-ocis-onlyoffice-rolling
  server:
    server_type: cx21
    image: ubuntu-22.04
    location: nbg1
    initial_ssh_key_names:
      - owncloud-ocis@drone.owncloud.com
    labels:
      owner: ocis-team
      for: oCIS-continuous-deployment-examples
    rebuild: $REBUILD
    rebuild_carry_paths:
      - /var/lib/docker/volumes/ocis_certs

  domains:
    - "*.ocis-onlyoffice.rolling.owncloud.works"

  vars:
    ssh_authorized_keys:
      - https://github.com/butonic.keys
      - https://github.com/fschade.keys
      - https://github.com/kulmann.keys
      - https://github.com/micbar.keys
      - https://github.com/rhafer.keys
      - https://github.com/wkloucek.keys
    docker_compose_projects:
      - name: ocis
        git_url: https://github.com/owncloud/ocis.git
        ref: master
        docker_compose_path: deployments/examples/ocis_full
        env:
          INSECURE: "false"
          TRAEFIK_ACME_MAIL: mbarz@owncloud.com
          OCIS_DOCKER_TAG: 6.1.0
          OCIS_DOCKER_IMAGE: owncloud/ocis-rolling
          OCIS_DOMAIN: ocis.ocis-onlyoffice.rolling.owncloud.works
          COMPANION_DOMAIN: companion.ocis-onlyoffice.rolling.owncloud.works
          COMPANION_IMAGE: owncloud/uppy-companion:3.12.13-owncloud
          WOPISERVER_ONLYOFFICE_DOMAIN: wopiserver-oo.ocis-onlyoffice.rolling.owncloud.works
          ONLYOFFICE_DOMAIN: onlyoffice.ocis-onlyoffice.rolling.owncloud.works
          INBUCKET_DOMAIN: mail.ocis-onlyoffice.rolling.owncloud.works
          DEMO_USERS: "true"
          COMPOSE_FILE: docker-compose.yml:ocis.yml:tika.yml:onlyoffice.yml:cloudimporter.yml:inbucket.yml:monitoring_tracing/monitoring-oo.yml
      - name: monitoring
        git_url: https://github.com/owncloud-devops/monitoring-tracing-client.git
        ref: master
        env:
          NETWORK_NAME: ocis-net
          TELEMETRY_SERVE_DOMAIN: telemetry.ocis-onlyoffice.rolling.owncloud.works
          JAEGER_COLLECTOR: jaeger-collector.infra.owncloud.works:443
          TELEGRAF_SPECIFIC_CONFIG: ocis_onlyoffice
          OCIS_URL: ocis.ocis-onlyoffice.rolling.owncloud.works
          OCIS_DEPLOYMENT_ID: continuous-deployment-ocis-onlyoffice-rolling
