---
kind: pipeline
type: docker
name: build_ocis_binary_for_testing

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis build
  volumes:
  - name: gopath
    path: /srv/app

- name: rebuild_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: true
    region: us-east-1
    restore: false
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-accounts

platform:
  os: linux
  arch: amd64

steps:
- name: frontend
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - cd accounts
  - yarn install --frozen-lockfile
  - yarn lint
  - yarn test
  - yarn build

- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C accounts generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C accounts vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C accounts staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C accounts lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C accounts test
  - mv accounts/coverage.out accounts_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: accounts_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/accounts/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-glauth

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C glauth generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C glauth vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C glauth staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C glauth lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C glauth test
  - mv glauth/coverage.out glauth_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: glauth_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/glauth/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-konnectd

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C konnectd generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C konnectd vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C konnectd staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C konnectd lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C konnectd test
  - mv konnectd/coverage.out konnectd_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: konnectd_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/konnectd/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-ocis

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis test
  - mv ocis/coverage.out ocis_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: ocis_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/ocis/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-ocis-phoenix

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-phoenix generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-phoenix vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-phoenix staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-phoenix lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-phoenix test
  - mv ocis-phoenix/coverage.out ocis-phoenix_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: ocis-phoenix_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/ocis-phoenix/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-ocis-pkg

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-pkg generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-pkg vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-pkg staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-pkg lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis-pkg test
  - mv ocis-pkg/coverage.out ocis-pkg_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: ocis-pkg_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/ocis-pkg/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-ocs

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocs generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocs vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocs staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocs lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocs test
  - mv ocs/coverage.out ocs_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: ocs_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/ocs/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-proxy

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C proxy generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C proxy vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C proxy staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C proxy lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C proxy test
  - mv proxy/coverage.out proxy_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: proxy_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/proxy/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-settings

platform:
  os: linux
  arch: amd64

steps:
- name: frontend
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - cd settings
  - yarn install --frozen-lockfile
  - yarn lint
  - yarn test
  - yarn build

- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C settings generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C settings vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C settings staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C settings lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C settings test
  - mv settings/coverage.out settings_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: settings_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/settings/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-storage

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C storage generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C storage vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C storage staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C storage lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C storage test
  - mv storage/coverage.out storage_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: storage_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/storage/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-store

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C store generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C store vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C store staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C store lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C store test
  - mv store/coverage.out store_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: store_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/store/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-thumbnails

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C thumbnails generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C thumbnails vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C thumbnails staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C thumbnails lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C thumbnails test
  - mv thumbnails/coverage.out thumbnails_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: thumbnails_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/thumbnails/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-webdav

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C webdav generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C webdav vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C webdav staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C webdav lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C webdav test
  - mv webdav/coverage.out webdav_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: webdav_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/webdav/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: linting&unitTests-onlyoffice

platform:
  os: linux
  arch: amd64

steps:
- name: frontend
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - cd onlyoffice
  - yarn install --frozen-lockfile
  - yarn lint
  - yarn test
  - yarn build

- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C onlyoffice generate
  volumes:
  - name: gopath
    path: /srv/app

- name: vet
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C onlyoffice vet
  volumes:
  - name: gopath
    path: /srv/app

- name: staticcheck
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C onlyoffice staticcheck
  volumes:
  - name: gopath
    path: /srv/app

- name: lint
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C onlyoffice lint
  volumes:
  - name: gopath
    path: /srv/app

- name: test
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C onlyoffice test
  - mv onlyoffice/coverage.out onlyoffice_coverage.out
  volumes:
  - name: gopath
    path: /srv/app

- name: coverage-cache
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: cache
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: onlyoffice_coverage.out
    target: /-${DRONE_BUILD_NUMBER}/coverage

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/tags/onlyoffice/v*
  - refs/pull/**

---
kind: pipeline
type: docker
name: upload-coverage

platform:
  os: linux
  arch: amd64

steps:
- name: sync-from-cache
  image: minio/mc
  commands:
  - mkdir -p coverage
  - mc mirror cache/cache//-${DRONE_BUILD_NUMBER}/coverage coverage/
  environment:
    MC_HOST_cache:
      from_secret: cache_s3_connection_url

- name: codacy
  pull: always
  image: plugins/codacy:1
  settings:
    token:
      from_secret: codacy_token

- name: sonarcloud
  pull: always
  image: sonarsource/sonar-scanner-cli
  environment:
    SONAR_PULL_REQUEST_BASE: None
    SONAR_PULL_REQUEST_BRANCH: None
    SONAR_PULL_REQUEST_KEY: None
    SONAR_TOKEN:
      from_secret: sonar_token

- name: purge-cache
  image: minio/mc
  commands:
  - mc rm --recursive --force cache/cache//-${DRONE_BUILD_NUMBER}/coverage
  environment:
    MC_HOST_cache:
      from_secret: cache_s3_connection_url

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice

---
kind: pipeline
type: docker
name: localApiTests-apiOcisSpecific-owncloud

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: localApiTests-apiOcisSpecific-owncloud
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@skipOnOcis-OC-Storage
    BEHAT_SUITE: apiOcisSpecific
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    PATH_TO_CORE: /srv/app/testrunner
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: localApiTests-apiOcisSpecific-ocis

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: localApiTests-apiOcisSpecific-ocis
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@skipOnOcis-OCIS-Storage
    BEHAT_SUITE: apiOcisSpecific
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    OCIS_SKELETON_STRATEGY: upload
    PATH_TO_CORE: /srv/app/testrunner
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: localApiTests-apiBasic-owncloud

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: localApiTests-apiBasic-owncloud
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@skipOnOcis-OC-Storage
    BEHAT_SUITE: apiBasic
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    PATH_TO_CORE: /srv/app/testrunner
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: localApiTests-apiBasic-ocis

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: localApiTests-apiBasic-ocis
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@skipOnOcis-OCIS-Storage
    BEHAT_SUITE: apiBasic
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    OCIS_SKELETON_STRATEGY: upload
    PATH_TO_CORE: /srv/app/testrunner
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-1

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-1
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 1
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-1

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-1
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 1
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-2

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 2
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-2

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 2
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-3

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-3
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 3
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-3

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-3
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 3
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-4

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-4
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 4
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-4

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-4
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 4
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-5

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-5
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 5
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-5

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-5
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 5
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-6

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-6
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 6
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-6

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-6
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 6
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-7

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-7
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 7
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-7

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-7
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 7
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-8

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-8
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 8
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-8

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-8
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 8
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-9

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-9
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 9
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-9

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-9
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 9
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-owncloud-storage-10

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-owncloud-storage-10
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OC-Storage
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OWNCLOUD-storage.txt
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    OCIS_SKELETON_STRATEGY: copy
    RUN_PART: 10
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: Core-API-Tests-ocis-storage-10

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: ocis
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: ocis
  volumes:
  - name: gopath
    path: /srv/app

- name: clone-core-repos
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/tmp/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/core.git /srv/app/testrunner
  - cd /srv/app/testrunner
  - git checkout 60eaf47d37f30e52362953e5c7db44140f927890
  volumes:
  - name: gopath
    path: /srv/app

- name: oC10ApiTests-ocis-storage-10
  pull: always
  image: owncloudci/php:7.4
  commands:
  - make -C /srv/app/testrunner test-acceptance-api
  environment:
    BEHAT_FILTER_TAGS: ~@notToImplementOnOCIS&&~@toImplementOnOCIS&&~comments-app-required&&~@federation-app-required&&~@notifications-app-required&&~systemtags-app-required&&~@local_storage&&~@skipOnOcis-OCIS-Storage
    DELETE_USER_DATA_CMD: rm -rf /srv/app/tmp/ocis/storage/users/nodes/root/* /srv/app/tmp/ocis/storage/users/nodes/*-*-*-*
    DIVIDE_INTO_NUM_PARTS: 10
    EXPECTED_FAILURES_FILE: /drone/src/tests/acceptance/expected-failures-on-OCIS-storage.txt
    OCIS_SKELETON_STRATEGY: upload
    RUN_PART: 10
    SKELETON_DIR: /srv/app/tmp/testing/data/apiSkeleton
    TEST_OCIS: true
    TEST_SERVER_URL: https://ocis-server:9200
  volumes:
  - name: gopath
    path: /srv/app

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIBasic

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUILogin tests/acceptance/features/webUINotifications tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIPreview tests/acceptance/features/webUIAccount "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUICreateFilesFolders

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUICreateFilesFolders "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIDeleteFilesFolders

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIDeleteFilesFolders "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIRename

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingBasic

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingAcceptShares tests/acceptance/features/webUISharingAcceptSharesToRoot "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIRestrictSharing

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIRestrictSharing "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingNotifications

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingNotifications tests/acceptance/features/webUISharingNotificationsToRoot "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIFavorites

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIFavorites "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIFiles

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIFiles "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingAutocompletion

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingAutocompletion "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingInternalGroups

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalGroups tests/acceptance/features/webUISharingInternalGroupsEdgeCases tests/acceptance/features/webUISharingInternalGroupsSharingIndicator tests/acceptance/features/webUISharingInternalGroupsToRoot tests/acceptance/features/webUISharingInternalGroupsToRootEdgeCases tests/acceptance/features/webUISharingInternalGroupsToRootSharingIndicator "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingInternalUsers

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsers tests/acceptance/features/webUISharingInternalUsersBlacklisted tests/acceptance/features/webUISharingInternalUsersSharingIndicator tests/acceptance/features/webUISharingInternalUsersToRoot tests/acceptance/features/webUISharingInternalUsersToRootBlacklisted tests/acceptance/features/webUISharingInternalUsersToRootSharingIndicator "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingInternalUsersExpire

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsersExpire "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingInternalUsersExpireToRoot

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsersExpireToRoot "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingPermissionsUsers

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingPermissionsUsers "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFilePermissionsGroups

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFilePermissionsGroups "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFolderPermissionsGroups

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFolderPermissionsGroups "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFolderAdvancedPermissionsGroups

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFolderAdvPermissionsGrp "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingPermissionToRoot

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingPermissionToRoot "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIResharing

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIResharing "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIResharingToRoot

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIResharingToRoot "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingPublic

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingPublic "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingPublicExpire

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingPublicExpire "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingPublicDifferentRoles

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingPublicDifferentRoles "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUITrashbin

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUITrashbin "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUITrashbinFilesFolders

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUITrashbinFilesFolders "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUITrashbinRestore

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUITrashbinRestore "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIUpload

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIUpload "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFilePermissionMultipleUsers

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFilePermissionMultipleUsers "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFolderPermissionMultipleUsers

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFolderPermissionMultipleUsers "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUISharingFolderAdvancedPermissionMultipleUsers

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUISharingFolderAdvancedPermissionMU "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: webUIMoveFilesFolders

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: webUITests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: https://ocis-server:9200
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_PATHS: "tests/acceptance/features/webUIMoveFilesFolders "
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: accountsUITests

platform:
  os: linux
  arch: amd64

steps:
- name: restore_ocis-binary-amd64_build_artifact_cache
  pull: always
  image: meltwater/drone-cache:v1
  settings:
    bucket: cache
    cache_key: /-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - ocis/bin/ocis
    path_style: true
    rebuild: false
    region: us-east-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key

- name: ocis-server
  pull: always
  image: webhippie/golang:1.14
  detach: true
  commands:
  - apk add mailcap
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ocis/bin/ocis server
  environment:
    ACCOUNTS_HASH_DIFFICULTY: 4
    KONNECTD_IDENTIFIER_REGISTRATION_CONF: /drone/src/tests/config/drone/identifier-registration.yml
    KONNECTD_ISS: https://ocis-server:9200
    KONNECTD_TLS: true
    OCIS_LOG_LEVEL: warn
    PHOENIX_WEB_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_DATAGATEWAY_PUBLIC_URL: https://ocis-server:9200/data
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_FRONTEND_PUBLIC_URL: https://ocis-server:9200
    STORAGE_HOME_DATA_SERVER_URL: http://ocis-server:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_LDAP_IDP: https://ocis-server:9200
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_OIDC_ISSUER: https://ocis-server:9200
    STORAGE_SHARING_USER_JSON_FILE: /srv/app/tmp/ocis/shares.json
    STORAGE_USERS_DATA_SERVER_URL: http://ocis-server:9158/data
    STORAGE_USERS_DRIVER: owncloud
  volumes:
  - name: gopath
    path: /srv/app

- name: WebUIAcceptanceTests
  pull: always
  image: webhippie/nodejs:latest
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/testing.git /srv/app/testing
  - git clone -b master --single-branch --no-tags https://github.com/owncloud/phoenix.git /srv/app/phoenix
  - cp -r /srv/app/phoenix/tests/acceptance/filesForUpload/* /uploads
  - cd /srv/app/phoenix
  - git checkout c136a4347548b022078294ea09f4eaa628a26097
  - yarn install-all
  - cd /drone/src/accounts
  - yarn install --all
  - make test-acceptance-webui
  environment:
    BACKEND_HOST: https://ocis-server:9200
    FEATURE_PATH: /drone/src/accounts/ui/tests/acceptance/features
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data
    OCIS_SKELETON_DIR: /srv/app/testing/data/webUISkeleton
    PHOENIX_CONFIG: /drone/src/tests/config/drone/ocis-config.json
    PHOENIX_PATH: /srv/app/phoenix
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis-server:9200
    TEST_TAGS: not @skipOnOCIS and not @skip
  volumes:
  - name: gopath
    path: /srv/app
  - name: uploads
    path: /uploads

services:
- name: redis
  pull: always
  image: webhippie/redis
  environment:
    REDIS_DATABASES: 1

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-20200326
  volumes:
  - name: uploads
    path: /uploads

volumes:
- name: gopath
  temp: {}
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- build_ocis_binary_for_testing

---
kind: pipeline
type: docker
name: docker-amd64

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis build
  volumes:
  - name: gopath
    path: /srv/app

- name: dryrun
  pull: always
  image: plugins/docker:18.09
  settings:
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.amd64
    dry_run: true
    tags: linux-amd64
  when:
    ref:
    - refs/pull/**

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    auto_tag_suffix: linux-amd64
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.amd64
    password:
      from_secret: docker_password
    username:
      from_secret: docker_username
  when:
    ref:
      exclude:
      - refs/pull/**

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: docker-arm64

platform:
  os: linux
  arch: arm64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis build
  volumes:
  - name: gopath
    path: /srv/app

- name: dryrun
  pull: always
  image: plugins/docker:18.09
  settings:
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.arm64
    dry_run: true
    tags: linux-arm64
  when:
    ref:
    - refs/pull/**

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    auto_tag_suffix: linux-arm64
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.arm64
    password:
      from_secret: docker_password
    username:
      from_secret: docker_username
  when:
    ref:
      exclude:
      - refs/pull/**

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: docker-arm

platform:
  os: linux
  arch: arm

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis build
  volumes:
  - name: gopath
    path: /srv/app

- name: dryrun
  pull: always
  image: plugins/docker:18.09
  settings:
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.arm
    dry_run: true
    tags: linux-arm
  when:
    ref:
    - refs/pull/**

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    auto_tag_suffix: linux-arm
    context: ocis
    dockerfile: ocis/docker/Dockerfile.linux.arm
    password:
      from_secret: docker_password
    username:
      from_secret: docker_username
  when:
    ref:
      exclude:
      - refs/pull/**

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: docker-eos-ocis

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis build
  volumes:
  - name: gopath
    path: /srv/app

- name: dryrun-eos-ocis
  pull: always
  image: plugins/docker:18.09
  settings:
    context: ocis/docker/eos-ocis
    dockerfile: ocis/docker/eos-ocis/Dockerfile
    dry_run: true
    repo: owncloud/eos-ocis
    tags: linux-eos-ocis
  when:
    ref:
    - refs/pull/**

- name: docker-eos-ocis
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    context: ocis/docker/eos-ocis
    dockerfile: ocis/docker/eos-ocis/Dockerfile
    password:
      from_secret: docker_password
    repo: owncloud/eos-ocis
    username:
      from_secret: docker_username
  when:
    ref:
      exclude:
      - refs/pull/**

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: binaries-linux

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-linux
  volumes:
  - name: gopath
    path: /srv/app

- name: finish
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-finish
  volumes:
  - name: gopath
    path: /srv/app
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: upload
  pull: always
  image: plugins/s3:1
  settings:
    access_key:
      from_secret: aws_access_key_id
    bucket:
      from_secret: s3_bucket
    endpoint:
      from_secret: s3_endpoint
    path_style: true
    secret_key:
      from_secret: aws_secret_access_key
    source: ocis/dist/release/*
    strip_prefix: dist/release/
    target: /ocis//testing
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: changelog
  pull: always
  image: toolhippie/calens:latest
  commands:
  - calens --version refs/tags/accouts/v1.2.3 -o ocis/dist/CHANGELOG.md
  when:
    ref:
    - refs/tags/v*

- name: release
  pull: always
  image: plugins/github-release:1
  settings:
    api_key:
      from_secret: github_token
    files:
    - ocis/dist/release/*
    note: ocis/dist/CHANGELOG.md
    overwrite: true
    title: refs/tags/accouts/v1.2.3
  when:
    ref:
    - refs/tags/v*

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: binaries-darwin

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-darwin
  volumes:
  - name: gopath
    path: /srv/app

- name: finish
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-finish
  volumes:
  - name: gopath
    path: /srv/app
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: upload
  pull: always
  image: plugins/s3:1
  settings:
    access_key:
      from_secret: aws_access_key_id
    bucket:
      from_secret: s3_bucket
    endpoint:
      from_secret: s3_endpoint
    path_style: true
    secret_key:
      from_secret: aws_secret_access_key
    source: ocis/dist/release/*
    strip_prefix: dist/release/
    target: /ocis//testing
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: changelog
  pull: always
  image: toolhippie/calens:latest
  commands:
  - calens --version refs/tags/accouts/v1.2.3 -o ocis/dist/CHANGELOG.md
  when:
    ref:
    - refs/tags/v*

- name: release
  pull: always
  image: plugins/github-release:1
  settings:
    api_key:
      from_secret: github_token
    files:
    - ocis/dist/release/*
    note: ocis/dist/CHANGELOG.md
    overwrite: true
    title: refs/tags/accouts/v1.2.3
  when:
    ref:
    - refs/tags/v*

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: binaries-windows

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis generate
  volumes:
  - name: gopath
    path: /srv/app

- name: build
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-windows
  volumes:
  - name: gopath
    path: /srv/app

- name: finish
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis release-finish
  volumes:
  - name: gopath
    path: /srv/app
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: upload
  pull: always
  image: plugins/s3:1
  settings:
    access_key:
      from_secret: aws_access_key_id
    bucket:
      from_secret: s3_bucket
    endpoint:
      from_secret: s3_endpoint
    path_style: true
    secret_key:
      from_secret: aws_secret_access_key
    source: ocis/dist/release/*
    strip_prefix: dist/release/
    target: /ocis//testing
  when:
    ref:
    - refs/heads/master
    - refs/tags/v*

- name: changelog
  pull: always
  image: toolhippie/calens:latest
  commands:
  - calens --version refs/tags/accouts/v1.2.3 -o ocis/dist/CHANGELOG.md
  when:
    ref:
    - refs/tags/v*

- name: release
  pull: always
  image: plugins/github-release:1
  settings:
    api_key:
      from_secret: github_token
    files:
    - ocis/dist/release/*
    note: ocis/dist/CHANGELOG.md
    overwrite: true
    title: refs/tags/accouts/v1.2.3
  when:
    ref:
    - refs/tags/v*

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**

depends_on:
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: release-accouts/v1.2.3

platform:
  os: linux
  arch: amd64

steps:
- name: release-submodule
  pull: always
  image: plugins/github-release:1
  settings:
    api_key:
      from_secret: github_token
    note: Release accouts 1.2.3 submodule
    overwrite: true
    title: accouts 1.2.3
  when:
    ref:
    - refs/tags/*/v*

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/*/v*

depends_on:
- linting&unitTests-accouts

---
kind: pipeline
type: docker
name: manifest

platform:
  os: linux
  arch: amd64

steps:
- name: execute
  pull: always
  image: plugins/manifest:1
  settings:
    auto_tag: true
    ignore_missing: true
    password:
      from_secret: docker_password
    spec: ocis/docker/manifest.tmpl
    username:
      from_secret: docker_username

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*

depends_on:
- docker-amd64
- docker-arm64
- docker-arm
- docker-eos-ocis
- binaries-linux
- binaries-darwin
- binaries-windows

---
kind: pipeline
type: docker
name: changelog

platform:
  os: linux
  arch: amd64

steps:
- name: generate
  pull: always
  image: webhippie/golang:1.14
  commands:
  - make -C ocis changelog

- name: diff
  pull: always
  image: owncloud/alpine:latest
  commands:
  - git diff

- name: output
  pull: always
  image: owncloud/alpine:latest
  commands:
  - cat CHANGELOG.md

- name: publish
  pull: always
  image: plugins/git-action:1
  settings:
    actions:
    - commit
    - push
    author_email: devops@owncloud.com
    author_name: ownClouders
    branch: master
    message: Automated changelog update [skip ci]
    netrc_machine: github.com
    netrc_password:
      from_secret: github_token
    netrc_username:
      from_secret: github_username
  when:
    ref:
      exclude:
      - refs/pull/**

trigger:
  ref:
  - refs/heads/master
  - refs/pull/**

depends_on:
- manifest

---
kind: pipeline
type: docker
name: readme

platform:
  os: linux
  arch: amd64

steps:
- name: execute
  pull: always
  image: sheogorath/readme-to-dockerhub:latest
  environment:
    DOCKERHUB_PASSWORD:
      from_secret: docker_password
    DOCKERHUB_USERNAME:
      from_secret: docker_username
    README_PATH: README.md
    SHORT_DESCRIPTION: "Docker images for "

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*

depends_on:
- docker-amd64
- docker-arm64
- docker-arm

---
kind: pipeline
type: docker
name: badges

platform:
  os: linux
  arch: amd64

steps:
- name: execute
  pull: always
  image: plugins/webhook:1
  settings:
    urls:
      from_secret: microbadger_url

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*

depends_on:
- docker-amd64
- docker-arm64
- docker-arm
- docker-eos-ocis

---
kind: pipeline
type: docker
name: docs

platform:
  os: linux
  arch: amd64

steps:
- name: generate-config-docs
  image: webhippie/golang:1.14
  commands:
  - make -C accounts config-docs-generate
  - make -C glauth config-docs-generate
  - make -C konnectd config-docs-generate
  - make -C ocis config-docs-generate
  - make -C ocis-phoenix config-docs-generate
  - make -C ocis-pkg config-docs-generate
  - make -C ocs config-docs-generate
  - make -C proxy config-docs-generate
  - make -C settings config-docs-generate
  - make -C storage config-docs-generate
  - make -C store config-docs-generate
  - make -C thumbnails config-docs-generate
  - make -C webdav config-docs-generate
  - make -C onlyoffice config-docs-generate
  volumes:
  - name: gopath
    path: /srv/app

- name: prepare
  image: owncloudci/alpine:latest
  commands:
  - make -C docs docs-copy

- name: test
  image: owncloudci/hugo:0.71.0
  commands:
  - cd docs/hugo
  - hugo

- name: publish
  pull: always
  image: plugins/gh-pages:1
  settings:
    pages_directory: docs/hugo/content
    password:
      from_secret: github_token
    target_branch: docs
    username:
      from_secret: github_username
  when:
    ref:
      exclude:
      - refs/pull/**

- name: list and remove temporary files
  image: owncloudci/alpine:latest
  commands:
  - tree hugo/public
  - rm -rf docs/hugo

- name: downstream
  image: plugins/downstream
  settings:
    repositories:
    - owncloud/owncloud.github.io@source
    server: https://drone.owncloud.com/
    token:
      from_secret: drone_token
  when:
    ref:
      exclude:
      - refs/pull/**

volumes:
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/heads/master
  - refs/pull/**

depends_on:
- badges

---
kind: pipeline
type: docker
name: updateDeployment

platform:
  os: linux
  arch: amd64

steps:
- name: webhook
  image: plugins/webhook
  settings:
    method: GET
    password:
      from_secret: webhook_password
    urls: https://ocis.owncloud.works/hooks/update-ocis
    username:
      from_secret: webhook_username

trigger:
  ref:
  - refs/heads/master

depends_on:
- docker-amd64
- docker-arm64
- docker-arm
- binaries-linux
- binaries-darwin
- binaries-windows

---
kind: pipeline
type: docker
name: purge_ocis-binary-amd64_build_artifact_cache

platform:
  os: linux
  arch: amd64

steps:
- name: purge-cache
  image: minio/mc
  commands:
  - mc rm --recursive --force cache/cache///-${DRONE_BUILD_NUMBER}/ocis-binary-amd64_build_artifact_cache
  environment:
    MC_HOST_cache:
      from_secret: cache_s3_connection_url
  failure: ignore

trigger:
  ref:
  - refs/heads/master
  - refs/tags/v*
  - refs/pull/**
  status:
  - success
  - failure

depends_on:
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: ocis-internal
    webhook:
      from_secret: private_rocketchat
  when:
    status:
    - failure

trigger:
  ref:
  - refs/heads/master
  - refs/heads/release*
  - refs/tags/**
  status:
  - failure

depends_on:
- build_ocis_binary_for_testing
- linting&unitTests-accounts
- linting&unitTests-glauth
- linting&unitTests-konnectd
- linting&unitTests-ocis
- linting&unitTests-ocis-phoenix
- linting&unitTests-ocis-pkg
- linting&unitTests-ocs
- linting&unitTests-proxy
- linting&unitTests-settings
- linting&unitTests-storage
- linting&unitTests-store
- linting&unitTests-thumbnails
- linting&unitTests-webdav
- linting&unitTests-onlyoffice
- upload-coverage
- localApiTests-apiOcisSpecific-owncloud
- localApiTests-apiOcisSpecific-ocis
- localApiTests-apiBasic-owncloud
- localApiTests-apiBasic-ocis
- Core-API-Tests-owncloud-storage-1
- Core-API-Tests-ocis-storage-1
- Core-API-Tests-owncloud-storage-2
- Core-API-Tests-ocis-storage-2
- Core-API-Tests-owncloud-storage-3
- Core-API-Tests-ocis-storage-3
- Core-API-Tests-owncloud-storage-4
- Core-API-Tests-ocis-storage-4
- Core-API-Tests-owncloud-storage-5
- Core-API-Tests-ocis-storage-5
- Core-API-Tests-owncloud-storage-6
- Core-API-Tests-ocis-storage-6
- Core-API-Tests-owncloud-storage-7
- Core-API-Tests-ocis-storage-7
- Core-API-Tests-owncloud-storage-8
- Core-API-Tests-ocis-storage-8
- Core-API-Tests-owncloud-storage-9
- Core-API-Tests-ocis-storage-9
- Core-API-Tests-owncloud-storage-10
- Core-API-Tests-ocis-storage-10
- webUIBasic
- webUICreateFilesFolders
- webUIDeleteFilesFolders
- webUIRename
- webUISharingBasic
- webUIRestrictSharing
- webUISharingNotifications
- webUIFavorites
- webUIFiles
- webUISharingAutocompletion
- webUISharingInternalGroups
- webUISharingInternalUsers
- webUISharingInternalUsersExpire
- webUISharingInternalUsersExpireToRoot
- webUISharingPermissionsUsers
- webUISharingFilePermissionsGroups
- webUISharingFolderPermissionsGroups
- webUISharingFolderAdvancedPermissionsGroups
- webUISharingPermissionToRoot
- webUIResharing
- webUIResharingToRoot
- webUISharingPublic
- webUISharingPublicExpire
- webUISharingPublicDifferentRoles
- webUITrashbin
- webUITrashbinFilesFolders
- webUITrashbinRestore
- webUIUpload
- webUISharingFilePermissionMultipleUsers
- webUISharingFolderPermissionMultipleUsers
- webUISharingFolderAdvancedPermissionMultipleUsers
- webUIMoveFilesFolders
- accountsUITests
- docker-amd64
- docker-arm64
- docker-arm
- docker-eos-ocis
- binaries-linux
- binaries-darwin
- binaries-windows
- release-accouts/v1.2.3
- manifest
- changelog
- readme
- badges
- docs
- updateDeployment
- purge_ocis-binary-amd64_build_artifact_cache

...
